name: Patch IPA with Frida Gadget

on:
  workflow_dispatch:
    inputs:
      ipa_url:
        description: "URL to IPA to patch (direct download link)"
        required: true
        default: "https://github.com/prateek147/DVIA-v2/releases/download/v2.0/DVIA-v2-swift.ipa"
        type: string
      gadget:
        description: "Gadget source: local path in repo, URL, 'latest', or 'X.Y.Z'"
        required: true
        default: "latest"
        type: string
      output_ipa:
        description: "Output IPA filename"
        required: true
        default: "patched-with-frida.ipa"
        type: string
      generate_config:
        description: "Generate Gadget config"
        required: true
        default: "resume"
        type: choice
        options:
          - "resume"
          - "wait"
          - "none"
      code_signing:
        description: "Only used if generate_config is not 'none'"
        required: true
        default: "required"
        type: choice
        options:
          - "required"
          - "optional"
          - "omit"
      listen_port:
        description: "Only used if generate_config is not 'none'"
        required: false
        default: "27044"
        type: string
      listen_address:
        description: "Only used if generate_config is not 'none'"
        required: false
        default: "127.0.0.1"
        type: string
      on_port_conflict:
        description: "Only used if generate_config is not 'none'"
        required: false
        default: "fail"
        type: choice
        options:
          - "fail"
          - "pick"

jobs:
  patch:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          python -m pip install --only-binary=:all: -r requirements.txt

      - name: Patch IPA
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          if [[ -z "${{ inputs.ipa_url }}" ]]; then
            echo "::error::ipa_url is required"
            exit 1
          fi

          curl -fsSL -L "${{ inputs.ipa_url }}" -o input.ipa
          IPA_INPUT="input.ipa"

          GADGET_ARG="${{ inputs.gadget }}"

          args=( -i "$IPA_INPUT" -g "$GADGET_ARG" -o "${{ inputs.output_ipa }}" )

          if [[ "${{ inputs.generate_config }}" != "none" ]]; then
            args+=( --generate-config "${{ inputs.generate_config }}" )
            args+=( --listen-address "${{ inputs.listen_address }}" )
            args+=( --listen-port "${{ inputs.listen_port }}" )
            args+=( --on-port-conflict "${{ inputs.on_port_conflict }}" )

            if [[ "${{ inputs.code_signing }}" != "omit" ]]; then
              args+=( --code-signing "${{ inputs.code_signing }}" )
            fi
          fi

          # Ubuntu runner: do not attempt ldid signing.
          args+=( --no-sign )

          python inject_frida_dylib.py "${args[@]}"

          test -f "${{ inputs.output_ipa }}"

      - name: Create GitHub Release (draft)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: frida-patched-${{ github.run_id }}
          name: Frida patched IPA (${{ github.run_number }})
          draft: true
          files: ${{ inputs.output_ipa }}
